{% extends "base.html" %}

{% block title %}Мой профиль{% endblock %}

{% block content %}
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <h1>Мой профиль</h1>
      
      <div class="d-flex gap-2">
        <!-- Кнопка редактирования профиля -->
        <a href="{% url 'profile_edit' %}" class="btn btn-outline-primary">
          <i class="bi bi-pencil"></i> Редактировать профиль
        </a>
        
        <!-- Кнопка выхода из аккаунта -->
        <form method="post" action="{% url 'logout' %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">
            <i class="bi bi-box-arrow-right me-1"></i> Выйти из аккаунта
          </button>
        </form>
      </div>
    </div>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h4>{{ user.get_full_name|default:user.username }}</h4>
        <p><strong>Email:</strong> {{ user.email|default:"не указан" }}</p>
        <p><strong>Рейтинг как арендодатель:</strong> 
          <span class="fw-bold text-primary">{{ rating }} ★</span>
          {% if rating == 0 %} (пока нет отзывов){% endif %}
        </p>
        <p><strong>Зарегистрирован:</strong> {{ user.date_joined|date:"d.m.Y H:i" }}</p>
      </div>
    </div>

    <!-- Мои товары -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Мои товары</h3>
      <a href="{% url 'catalog:product_create' %}" class="btn btn-success">
        <i class="bi bi-plus-lg me-1"></i> Добавить товар
      </a>
    </div>
    {% if my_products %}
      <div class="row row-cols-1 row-cols-md-3 g-4 mb-5">
        {% for product in my_products %}
          <div class="col">
            <div class="card h-100 shadow-sm">
              {% if product.photo %}
                <img src="{{ product.photo.url }}" class="card-img-top" alt="{{ product.name }}" style="height: 180px; object-fit: cover;">
              {% else %}
                <img src="https://via.placeholder.com/300x180?text=Нет+фото" class="card-img-top" alt="Нет фото">
              {% endif %}
              <div class="card-body">
                <h5 class="card-title">{{ product.name }}</h5>
                <p class="card-text text-muted small">Автор: {{ product.author|default:"не указан" }}</p>
                <p class="card-text fw-bold">{{ product.daily_price }} ₽ / день</p>
              </div>
              <div class="card-footer text-center">
                <a href="{% url 'catalog:product_detail' product.pk %}" class="btn btn-primary btn-sm">Подробнее</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info mb-5">
        У вас пока нет добавленных товаров.
      </div>
    {% endif %}

    <!-- Мои бронирования -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Мои бронирования</h3>
      <a href="{% url 'bookings:my_bookings' %}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-right me-1"></i> Посмотреть все
      </a>
    </div>
    {% if my_bookings %}
      <div class="table-responsive mb-5">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Товар</th>
              <th>Даты</th>
              <th>Стоимость</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody>
            {% for booking in my_bookings %}
              <tr>
                <td><a href="{% url 'catalog:product_detail' booking.product.pk %}">{{ booking.product.name }}</a></td>
                <td>{{ booking.start_date|date:"d.m.Y" }} — {{ booking.end_date|date:"d.m.Y" }}</td>
                <td>{{ booking.total_cost }} ₽</td>
                <td>
                  {% if booking.status == 'pending' %}
                    <span class="badge bg-warning">Ожидает</span>
                  {% elif booking.status == 'confirmed' %}
                    <span class="badge bg-success">Подтверждено</span>
                  {% elif booking.status == 'active' %}
                    <span class="badge bg-info">Активно</span>
                  {% elif booking.status == 'completed' %}
                    <span class="badge bg-secondary">Завершено</span>
                  {% else %}
                    <span class="badge bg-danger">Отменено</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info mb-5">
        У вас пока нет бронирований.
      </div>
    {% endif %}

    <!-- Запросы на мои товары -->
    <h3 class="mb-3">Запросы на мои товары</h3>
    {% if owner_requests %}
      <div class="table-responsive mb-5">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Товар</th>
              <th>Арендатор</th>
              <th>Даты</th>
              <th>Стоимость</th>
              <th>Статус</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for req in owner_requests %}
              <tr>
                <td>{{ req.product.name }}</td>
                <td>{{ req.renter.username }}</td>
                <td>{{ req.start_date|date:"d.m.Y" }} — {{ req.end_date|date:"d.m.Y" }}</td>
                <td>{{ req.total_cost }} ₽</td>
                <td>
                  <span class="badge bg-{% if req.status == 'pending' %}warning{% elif req.status == 'confirmed' %}success{% elif req.status == 'active' %}info{% else %}danger{% endif %}">
                    {{ req.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if req.status == 'pending' %}
                    <form method="post" action="{% url 'bookings:owner_requests' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="booking_id" value="{{ req.id }}">
                      <input type="hidden" name="action" value="confirm">
                      <button type="submit" class="btn btn-sm btn-success">Подтвердить</button>
                    </form>
                    <form method="post" action="{% url 'bookings:owner_requests' %}" class="d-inline ms-2">
                      {% csrf_token %}
                      <input type="hidden" name="booking_id" value="{{ req.id }}">
                      <input type="hidden" name="action" value="cancel">
                      <button type="submit" class="btn btn-sm btn-danger">Отклонить</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">На ваши товары пока нет запросов.</p>
    {% endif %}
  </div>
{% endblock %}